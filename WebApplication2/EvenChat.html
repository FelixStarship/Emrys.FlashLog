<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
	<meta charset="utf-8" />
    <script src="Scripts/jquery-1.10.2.js"></script>
    <script src="Scripts/jquery.signalR-2.1.2.js"></script>
    <script src="/signalr/hubs"></script>
    <script type="text/javascript">

        var chat;
        var roomcount = 0;
        $(function () {
            $(function () {
                chat = $.connection.groupsHub;
                chat.client.showMessage = function (Message)
                {
                    alert(Message);
                }
                chat.client.sendMessage = function (roomname,message)
                {
                    $("#" + roomname).find("ul").each(function () {
                        $(this).append("<li>" + message + "</li>");
                    });
                }
                chat.client.removeRoom = function (data)
                {
                    alert(data);
                }
                chat.client.addRoom = function (roomname)
                {
                    var html = '<div style="float:left; margin-left:30px; border:double" id="' + roomname + '" roomname="' + roomname + '"><button onclick="RemoveRoom(this)">退出</button>\
                               '+ roomname + '房间\
                                              聊天记录如下：<ul>\
                                              </ul>\
                                              <input type="text"/><button onclick="SendMessage(this)">发送</button>\
                                              </div>';
                    $("#RoomList").append(html);
                }
                chat.client.getRoomlist = function (data)
                {
                    if (data)
                    {
                        var jsondata = $.parseJSON(data);
                        $("#RoomList").html(" ");
                        for (var i = 0; i <jsondata.length; i++) {
                            var html = '<li>房间名：' + jsondata[i].RoomName + '<button roomname="' + jsondata[i].RoomName + '" onclick="AddRoom(this)">加入</button></li>';
                            $("#RoomList").append(html);
                        }
                    }
                }
                $("#username").html(prompt("请输入你的名称："));
                $.connection.hub.start().done(function () {
                    $("#CreateRoom").click(function () {
                        if (roomcount < 2) {
                            chat.server.creatRoom($("#RoomName").val());
                            roomcount++;
                        } else
                        {
                            alert("聊天窗口只允许有2个");
                        }
                    });
                });
            });
        });

        function SendMessage(btn)
        {
            var message = $(btn).prev().val();
            var room = $(btn).parent();
            var username = $("#username").html();
            message = username + ":" + message;
            var roomname = $(room).attr("roomname");
            chat.server.sendMessage(roomname, message);
        }
        function RemoveRoom(btn)
        {

        }
    </script>
</head>
<body>
    <div>
        <div>名称:<p id="username"></p></div>
        输入房间名:
        <input type="text" value="asdasd" id="Roomname" />
        <button id="CreateRoom">创建聊天室</button>
    </div>
    <div style="float:left;border:double">
        <div>房间列表</div>
        <ul id="roomlist"></ul>
    </div>
    <div id="RoomList">
    </div>
</body>
</html>
